# .github/workflows/main-deploy.yml (FINAL)

name: ‚öôÔ∏è DEDALUS - Deploy Centralizado (BACKEND & FRONTEND)

on:
  push:
    branches:
      - main

jobs:
  # -----------------------------------------------------
  # 1. Job do Backend: Build e Deploy do Motor de Orquestra√ß√£o
  # -----------------------------------------------------
  deploy-backend:
    runs-on: ubuntu-latest
    name: Build & Deploy Backend
    environment: Production # Define o ambiente (opcional, para controle e logs)
    
    # Executa SOMENTE se houver mudan√ßas no backend ou se o commit for for√ßado
    if: |
      contains(github.event.commits.*.modified, 'backend/orchestration-engine/') ||
      contains(github.event.commits.*.added, 'backend/orchestration-engine/') ||
      github.event_name == 'workflow_dispatch'

    steps:
    - name: ‚¨áÔ∏è Checkout do C√≥digo
      uses: actions/checkout@v4
      
    - name: üõ†Ô∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ‚öôÔ∏è Instalar, Buildar e Preparar Prisma
      run: |
        cd backend/orchestration-engine
        npm install
        # Gera o cliente Prisma com base no schema.prisma
        npx prisma generate
        npm run build 

    - name: üì¶ Preparar Arquivos de Deployment
      # Criamos um ZIP que inclui a dist/, node_modules/ e package.json
      run: |
        cd backend/orchestration-engine
        zip -r backend-deploy.zip dist node_modules package.json

    - name: üöÄ Deploy Backend (FTP/SFTP)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      with:
        # Credenciais e Host do ezyro/FTP
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        # Diret√≥rio onde o servidor Node.js ir√° rodar (Ex: dedalus-backend/)
        server-dir: /dedalus-backend/ 
        # Upload do arquivo ZIP
        file-pattern: 'backend/orchestration-engine/backend-deploy.zip'
        # COMANDO CRUCIAL: Descompacta o ZIP no servidor ap√≥s o upload
        args: --skip-passive --delete-local --unzip 'backend/orchestration-engine/backend-deploy.zip' --dest /dedalus-backend/

  # -----------------------------------------------------
  # 2. Job do Frontend: Build e Deploy do Designer Low-Code
  # -----------------------------------------------------
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [deploy-backend] # Executa ap√≥s o backend (garante que as APIs estejam prontas)
    name: Build & Deploy Frontend
    
    # Executa SOMENTE se houver mudan√ßas no frontend
    if: |
      contains(github.event.commits.*.modified, 'frontend/designer-ui/') ||
      contains(github.event.commits.*.added, 'frontend/designer-ui/')

    steps:
    - name: ‚¨áÔ∏è Checkout do C√≥digo
      uses: actions/checkout@v4
      
    - name: üõ†Ô∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: üé® Instalar e Buildar Frontend
      run: |
        cd frontend/designer-ui
        npm install
        npm run build
        
    - name: üöÄ Deploy Frontend (FTP/SFTP)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        # Diret√≥rio raiz web (onde o index.html deve ficar)
        server-dir: /htdocs/ 
        # Faz upload de todo o conte√∫do da pasta build/
        local-dir: ./frontend/designer-ui/build/
        # Limpa o diret√≥rio remoto antes do upload
        args: --delete-local --delete-remote
