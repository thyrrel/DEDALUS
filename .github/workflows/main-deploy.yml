# .github/workflows/main-deploy.yml (EXECU√á√ÉO FOR√áADA)

name: ‚öôÔ∏è DEDALUS - Deploy Centralizado (EXECU√á√ÉO FOR√áADA)

on:
  push:
    branches:
      - main
  # Mantemos o workflow_dispatch para permitir execu√ß√µes manuais
  workflow_dispatch: 

jobs:
  # -----------------------------------------------------
  # 1. Job do Backend: Motor de Orquestra√ß√£o (SEMPRE RODA)
  # -----------------------------------------------------
  deploy-backend:
    runs-on: ubuntu-latest
    name: Build & Deploy Backend
    environment: Production
    # A linha 'if:' foi removida, garantindo que este Job SEMPRE execute.
    
    steps:
    - name: ‚¨áÔ∏è Checkout do C√≥digo
      uses: actions/checkout@v4
      
    - name: üõ†Ô∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ‚öôÔ∏è Instalar, Buildar e Preparar Prisma
      run: |
        cd backend/orchestration-engine
        npm install
        npx prisma generate
        npm run build 

    - name: üì¶ Preparar Arquivos de Deployment
      run: |
        cd backend/orchestration-engine
        zip -r backend-deploy.zip dist node_modules package.json

    - name: üöÄ Deploy Backend (FTP/SFTP)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        server-dir: /dedalus-backend/ 
        file-pattern: 'backend/orchestration-engine/backend-deploy.zip'
        args: --skip-passive --delete-local --unzip 'backend/orchestration-engine/backend-deploy.zip' --dest /dedalus-backend/
      
  # -----------------------------------------------------
  # 2. Job do Frontend: Designer Low-Code (SEMPRE RODA)
  # -----------------------------------------------------
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [deploy-backend]
    name: Build & Deploy Frontend
    # A linha 'if:' foi removida, garantindo que este Job SEMPRE execute.

    steps:
    - name: ‚¨áÔ∏è Checkout do C√≥digo
      uses: actions/checkout@v4
      
    - name: üõ†Ô∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: üé® Instalar e Buildar Frontend
      run: |
        cd frontend/designer-ui
        npm install
        npm run build
        
    - name: üöÄ Deploy Frontend (FTP/SFTP)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        server-dir: /htdocs/
        local-dir: ./frontend/designer-ui/build/
        args: --delete-local --delete-remote
