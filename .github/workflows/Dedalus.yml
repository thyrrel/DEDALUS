# .github/workflows/main-deploy.yml (FINAL & PARALELO)

name: âš™ï¸ DEDALUS - Deploy Centralizado (PARALELO)

on:
  push:
    branches:
      - main
  workflow_dispatch: 

jobs:
  # -----------------------------------------------------
  # 1. Job do Backend: Motor de OrquestraÃ§Ã£o
  # -----------------------------------------------------
  deploy-backend:
    runs-on: ubuntu-latest
    name: Build & Deploy Backend
    environment: Production
    
    steps:
    - name: â¬‡ï¸ Checkout do CÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: âš™ï¸ Instalar, Buildar e Preparar Prisma
      run: |
        cd backend/orchestration-engine
        npm install
        npx prisma generate
        npm run build 

    - name: ğŸ“¦ Preparar Arquivos de Deployment
      run: |
        cd backend/orchestration-engine
        zip -r backend-deploy.zip dist node_modules package.json

    - name: ğŸš€ Deploy Backend (FTP/SFTP)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        server-dir: /dedalus-backend/ 
        file-pattern: 'backend/orchestration-engine/backend-deploy.zip'
        args: --skip-passive --delete-local --unzip 'backend/orchestration-engine/backend-deploy.zip' --dest /dedalus-backend/
      
  # -----------------------------------------------------
  # 2. Job do Frontend: Designer Low-Code
  # -----------------------------------------------------
  deploy-frontend:
    runs-on: ubuntu-latest
    name: Build & Deploy Frontend

    steps:
    - name: â¬‡ï¸ Checkout do CÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ğŸ¨ Instalar e Buildar Frontend
      run: |
        cd frontend/designer-ui
        # O build agora executa: PUBLIC_URL=./ react-scripts build
        npm install --legacy-peer-deps 
        npm run build
        
    - name: ğŸš€ Deploy Frontend (FTP/SFTP)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        server-dir: /htdocs/
        local-dir: ./frontend/designer-ui/build/
        args: --delete-local --delete-remote
