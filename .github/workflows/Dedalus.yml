# .github/workflows/main-deploy.yml (FINAL & PARALELO)

name: âš™ï¸ DEDALUS - Deploy Centralizado (PARALELO)

on:
  push:
    branches:
      - main
  workflow_dispatch: 

jobs:
  # -----------------------------------------------------
  # 1. Job do Backend: Motor de OrquestraÃ§Ã£o
  # -----------------------------------------------------
  deploy-backend:
    runs-on: ubuntu-latest
    name: Build & Deploy Backend
    environment: Production
    
    steps:
    - name: â¬‡ï¸ Checkout do CÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ› ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: âš™ï¸ Instalar, Buildar e Preparar Prisma
      run: |
        cd backend/orchestration-engine
        npm install
        npx prisma generate
        npm run build 

    - name: ðŸ“¦ Preparar Arquivos de Deployment
      run: |
        cd backend/orchestration-engine
        zip -r backend-deploy.zip dist node_modules package.json

    - name: ðŸš€ Deploy Backend (FTP/SFTP)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        server-dir: /dedalus-backend/ 
        file-pattern: 'backend/orchestration-engine/backend-deploy.zip'
        args: --skip-passive --delete-local --unzip 'backend/orchestration-engine/backend-deploy.zip' --dest /dedalus-backend/
      
  # -----------------------------------------------------
  # 2. Job do Frontend: Designer Low-Code
  # -----------------------------------------------------
  deploy-frontend:
    runs-on: ubuntu-latest
    # DEPENDÃŠNCIA REMOVIDA (EXECUÃ‡ÃƒO PARALELA)
    name: Build & Deploy Frontend

    steps:
    - name: â¬‡ï¸ Checkout do CÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ› ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # PASSO CRUCIAL PARA CORRIGIR O PATH (DEDALUS/DEDALUS)
    - name: ðŸ“ Configurar Variavel de Ambiente PUBLIC_URL
      run: echo "PUBLIC_URL=." >> $GITHUB_ENV
      
    - name: ðŸŽ¨ Instalar e Buildar Frontend (CORRIGIDO)
      run: |
        cd frontend/designer-ui
        npm install --legacy-peer-deps 
        # O build agora usarÃ¡ PUBLIC_URL=. para encontrar o index.html e os assets
        npm run build
        
    - name: ðŸš€ Deploy Frontend (FTP/SFTP)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        server-dir: /htdocs/
        local-dir: ./frontend/designer-ui/build/
        args: --delete-local --delete-remote
