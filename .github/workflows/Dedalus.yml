# .github/workflows/main-deploy.yml (FINAL & PARALELO)

name: ‚öôÔ∏è DEDALUS - Deploy Centralizado (PARALELO)

on:
  push:
    branches:
      - main
  workflow_dispatch: 

jobs:
  # -----------------------------------------------------
  # 1. Job do Backend: Motor de Orquestra√ß√£o
  # -----------------------------------------------------
  deploy-backend:
    runs-on: ubuntu-latest
    name: Build & Deploy Backend
    environment: Production
    
    steps:
    - name: ‚¨áÔ∏è Checkout do C√≥digo
      uses: actions/checkout@v4
      
    - name: üõ†Ô∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ‚öôÔ∏è Instalar, Buildar e Preparar Prisma (CORRIGIDO)
      run: |
        cd backend/orchestration-engine
        # O 'npm install' agora instalar√° o @prisma/client explicitamente
        npm install
        npx prisma generate
        npm run build 

    - name: üì¶ Preparar Arquivos de Deployment
      run: |
        cd backend/orchestration-engine
        zip -r backend-deploy.zip dist node_modules package.json

    - name: üöÄ Deploy Backend (FTP/SFTP)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        server-dir: /dedalus-backend/ 
        file-pattern: 'backend/orchestration-engine/backend-deploy.zip'
        args: --skip-passive --delete-local --unzip 'backend/orchestration-engine/backend-deploy.zip' --dest /dedalus-backend/
      
  # -----------------------------------------------------
  # 2. Job do Frontend: Designer Low-Code
  # -----------------------------------------------------
  deploy-frontend:
    runs-on: ubuntu-latest
    # DEPEND√äNCIA REMOVIDA para permitir execu√ß√£o PARALELA
    name: Build & Deploy Frontend

    steps:
    - name: ‚¨áÔ∏è Checkout do C√≥digo
      uses: actions/checkout@v4
      
    - name: üõ†Ô∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: üé® Instalar e Buildar Frontend (CORRIGIDO)
      run: |
        cd frontend/designer-ui
        # CORRE√á√ÉO: Adiciona a flag para resolver o conflito de peer dependency do TypeScript
        npm install --legacy-peer-deps 
        npm run build
        
    - name: üöÄ Deploy Frontend (FTP/SFTP)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        server-dir: /htdocs/
        local-dir: ./frontend/designer-ui/build/
        args: --delete-local --delete-remote
